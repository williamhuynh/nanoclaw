---
name: github-pr
description: Create branches, push changes, and manage pull requests using the gh CLI. Use for all GitHub operations.
---

# GitHub PR Workflow

## Overview

Manages the full PR lifecycle: branch creation, pushing changes, creating PRs, and handling auto-merge for auto-fix tier changes. Uses the `gh` CLI authenticated via a fine-grained PAT.

## Prerequisites

Before any GitHub operation, authenticate:

```bash
gh auth login --with-token < /workspace/group/.github-token
gh auth status
```

If auth fails, report to user and stop.

## Clone Repository

At the start of every session that needs code access:

```bash
cd /workspace/group
if [ ! -d "homeschoollms" ]; then
  gh repo clone [OWNER]/[REPO] homeschoollms
fi
cd homeschoollms
git pull origin main
```

Replace `[OWNER]/[REPO]` with the actual GitHub repo path (documented in group CLAUDE.md).

## Creating a PR

### For Auto-Fix Tier Changes

1. Create branch:
   ```bash
   git checkout -b auto-fix/$(date +%Y%m%d)-short-description
   ```

2. Make changes, stage, commit:
   ```bash
   git add [specific files]
   git commit -m "fix: [description of what was fixed and why]"
   ```

3. Push and create PR:
   ```bash
   git push -u origin HEAD
   gh pr create \
     --title "Auto-fix: [short description]" \
     --body "## Auto-Fix

   **Root cause:** [What caused the issue]
   **Fix:** [What was changed]
   **Tests:** [Test results]

   This PR was auto-generated and will auto-merge in 1 hour if no objections.

   ---
   *Generated by HomeschoolLMS Dev Agent*"
   ```

4. Notify user via `mcp__nanoclaw__send_message`:
   ```
   Auto-fix PR created: [PR URL]

   Fix: [description]
   Changed: [file list]
   Tests: [pass/fail status]

   Will auto-merge in 1 hour. Reply "hold" to prevent merge.
   ```

5. The auto-merge after 1 hour is handled by a scheduled task (set up in CLAUDE.md). The agent does NOT wait — it creates the PR, notifies, and moves on.

### For PR Tier Changes

1. Create branch:
   ```bash
   git checkout -b dev/$(date +%Y%m%d)-short-description
   ```

2. Make changes, stage, commit (potentially multiple commits):
   ```bash
   git add [specific files]
   git commit -m "feat: [description]"
   ```

3. Push and create PR:
   ```bash
   git push -u origin HEAD
   gh pr create \
     --title "[type]: [short description]" \
     --body "## Summary
   [What this PR does and why]

   ## Changes
   [Bulleted list of changes]

   ## Test Results
   [Output of test/lint commands]

   ## Notes
   [Anything the reviewer should know]

   ---
   *Generated by HomeschoolLMS Dev Agent*"
   ```

4. Notify user via `mcp__nanoclaw__send_message`:
   ```
   PR ready for review: [PR URL]

   [Summary of what was implemented]
   [Test results]

   Please review when you have a chance.
   ```

## Auto-Merge Check

When checking if an auto-fix PR should be merged (called by scheduled task):

```bash
# Get PR creation time and check for hold comments
PR_CREATED=$(gh pr view [PR_NUMBER] --json createdAt --jq '.createdAt')
HOLD_COMMENT=$(gh pr view [PR_NUMBER] --json comments --jq '.comments[].body' | grep -i "hold" || true)

if [ -n "$HOLD_COMMENT" ]; then
  echo "Hold requested — skipping merge"
  exit 0
fi

# Calculate age in seconds
NOW=$(date -u +%s)
PR_EPOCH=$(date -u -d "$PR_CREATED" +%s)
AGE_SECONDS=$(( NOW - PR_EPOCH ))

if [ "$AGE_SECONDS" -ge 3600 ]; then
  gh pr merge [PR_NUMBER] --merge
  echo "Auto-merged after 1 hour hold window"
else
  echo "PR is $(( AGE_SECONDS / 60 )) minutes old — waiting for 1 hour"
fi
```

## Error Handling

- Push rejected: report conflict to user, do not force push
- PR creation fails: report error with details
- Auth failure: report and stop, do not retry with bad credentials
